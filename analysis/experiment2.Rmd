---
title: "Analysis of Experiment 1"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Load data and R packages

```{r results='hide', message=F, warning=F}
library(brms)
library(bayesplot)
library(tidyverse)
library(gridExtra)
library(kableExtra)
library(bayestestR)
library(tidybayes)
source("code/helper_functions.R")

exp2_treatments <- c("Ringer CHC", "LPS CHC")

durations <- read_csv("data/data_collection_sheets/experiment_durations.csv") %>%
  filter(experiment == 2) %>% select(-experiment)

outcome_tally <- read_csv(file = "data/clean_data/experiment_2_outcome_tally.csv") %>%
  mutate(outcome = factor(outcome, levels = c("Stayed inside the hive", "Left of own volition", "Forced out")),
         treatment = factor(treatment, levels = exp2_treatments))

# Re-formatted version of the same data, where each row is an individual bee. We need this format to run the brms model.
data_for_categorical_model <- outcome_tally %>%
  mutate(id = 1:n()) %>%
  split(.$id) %>%
  map(function(x){
    if(x$n[1] == 0) return(NULL)
    data.frame(
      treatment = x$treatment[1],
      hive = x$hive[1],
      colour = x$colour[1],
      outcome = rep(x$outcome[1], x$n))
  }) %>% do.call("rbind", .) %>% as_tibble() %>%
  arrange(hive, treatment) %>%
  mutate(outcome_numeric = as.numeric(outcome),
         hive = as.character(hive),
         treatment = factor(treatment, levels = exp2_treatments)) %>%
  left_join(durations, by = "hive")
```


## Inspect the raw data

### Table format

```{r}
outcome_tally %>% 
  kable(digits = 3) %>% kable_styling() %>%
  scroll_box(height = "380px")
```

### Plotted as a bar chart

```{r fig.width=11, fig.height=5}
all_hives <- outcome_tally %>%
  group_by(treatment, outcome) %>%
  summarise(n = sum(n)) %>%
  ungroup() %>% mutate(hive = "All hives")

outcome_tally %>%
  group_by(treatment, hive, outcome) %>%
  summarise(n = sum(n)) %>%
  ungroup() %>%
  mutate(hive = paste(hive, "hive")) %>%
  full_join(all_hives, by = c("treatment", "hive", "outcome", "n")) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(outcome, n , fill = treatment)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  facet_wrap( ~ hive, nrow = 1, scales = "free_y") + 
  scale_fill_brewer(palette = "Set2", name = "Treatment") + 
  xlab("Outcome") + ylab("Number of bees") + 
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

## Multinomial model of outcome

### Run the models

Fit a multinomial logisitic model, with 3 possible outcomes describing what happened to each bee introduced to the hive: stayed inside, left of its own volition, or forced out by the other workers. To assess the effects of our predictor variables, we compare 5 models with different fixed factors, ranking them by posterior model probability.

```{r}
if(!file.exists("output/model_probabilities_expt2.rds")){
  my_prior <- c(set_prior("normal(0, 2)", class = "b"))
  
  run_brms_categorical <- function(formula){
    formula <- gsub(" ", "", paste("outcome_numeric ~", formula))
    brm(formula, 
        data = data_for_categorical_model, 
        prior = my_prior,
        family = "categorical", 
        save_all_pars = TRUE,
        control = list(adapt_delta = 0.999, max_treedepth = 15),
        chains = 4, cores = 4, iter = 40000, seed = 1)
  }
  
  formula_list <- c(
    "treatment:hive + treatment + hive + observation_time_minutes",
    "treatment + hive + observation_time_minutes",
    "treatment + observation_time_minutes",
    "hive + observation_time_minutes",
    "observation_time_minutes")
  
  # run all 5 models, sequentially
  model_list_expt2 <- lapply(formula_list, run_brms_categorical)
  
  # Estimate the log marginal likelihood by bridge sampling, and use to determine the posterior model probabilities
  # See: vignette("bridgesampling_example_stan")
  model_probabilities <- post_prob(model_list_expt2[[1]], 
                                   model_list_expt2[[2]], 
                                   model_list_expt2[[3]], 
                                   model_list_expt2[[4]], 
                                   model_list_expt2[[5]])
  top_index <- which.max(unname(model_probabilities))
  
  model_probabilities <- tibble(
    `Fixed effects` = formula_list, 
    `Posterior model probability` = unname(model_probabilities)) %>%
    arrange(-`Posterior model probability`)
  
  model_probabilities <- model_probabilities %>%
    mutate(`% of top model probability` = round(100 * `Posterior model probability` / `Posterior model probability`[1], 1),
           `% of top model probability` = c("\\-", `% of top model probability`[2:length(`% of top model probability`)]))
  
 # saveRDS(model_list_expt2[[1]], "output/full_model_expt2.rds")
  saveRDS(model_list_expt2[[top_index]], "output/top_model_expt2.rds")
  saveRDS(model_probabilities, "output/model_probabilities_expt2.rds")
}

top_model <- readRDS("output/top_model_expt2.rds")
model_probabilities <- readRDS("output/model_probabilities_expt2.rds")
```

### Posterior model probabilites

```{r}
model_probabilities %>% 
  kable(digits = 3) %>% kable_styling()
```

### Fixed effects from the top model

The model output suggests that the third possible outcome (i.e. being forced out of the hive; denoted as mu3 in the table) was more common in the 'LPS CHCs' treatment group. See _Hypothesis testing and effect sizes_ below for more useful statistical results.

```{r}
get_fixed_effects_with_p_values(top_model) %>% 
  kable(digits = 3) %>% kable_styling()
```


## Plotting estimates from the model

### Derive prediction from the posterior

```{r}
new <- expand.grid(treatment = levels(data_for_categorical_model$treatment), 
                   observation_time_minutes = 120)

preds <- fitted(top_model, newdata = new, summary = FALSE)
dimnames(preds) <- list(NULL, new[,1], NULL)

plotting_data <- rbind(
  as.data.frame(preds[,, 1]) %>% mutate(outcome = "Stayed inside the hive", posterior_sample = 1:n()),
  as.data.frame(preds[,, 2]) %>% mutate(outcome = "Left voluntarily", posterior_sample = 1:n()),
  as.data.frame(preds[,, 3]) %>% mutate(outcome = "Forced out", posterior_sample = 1:n())) %>%
  gather(treatment, prop, `Ringer CHC`, `LPS CHC`) %>%
  mutate(treatment = factor(treatment, c("Ringer CHC", "LPS CHC")),
         outcome = factor(outcome, c("Stayed inside the hive", "Left voluntarily", "Forced out"))) %>%
  as_tibble() %>% arrange(treatment, outcome) 
```

### Make Figure 2

```{r}
ggplot(plotting_data, aes(treatment, 100 * prop)) + 
  geom_eye(aes(fill = treatment)) + 
  scale_fill_brewer(palette = "Pastel1", direction = -1) + 
  facet_wrap( ~ outcome, scales = "free_y") + 
  ylab("% bees leaving the hive this way") + 
  xlab("Mode of exit") + 
  theme_bw() + 
  theme(legend.position = "none") 
```

## Hypothesis testing and effect sizes

This section calculates the posterior difference in treatment group means, in order to perform some null hypothesis testing, calculate effect size, and calculate the 95% credible intervals on the effect size. In all cases, the effect size expresses the effect of the "LPS-treated bee CHCs" treatment relative to the "Ringer-treated bee CHCs" control. 


### % bees exiting the hive

```{r}
my_summary <- function(df, columns, outcome) {
  lapply(columns, function(x){
    
    p <- df %>% pull(!! x) %>% bayestestR::p_direction() %>% as.numeric()
    p <- (100 - p) / 100
    
    df %>% pull(!! x) %>% posterior_summary() %>% as_tibble() %>% 
      mutate(p=p, Outcome = outcome, Metric = x) %>% select(Outcome, Metric, everything())
  }) %>% do.call("rbind", .)
}

stats_table <- rbind(
  plotting_data %>%
    filter(outcome == "Stayed inside the hive") %>%
    mutate(prop = 1 - prop) %>%
    spread(treatment, prop) %>%
    mutate(`Absolute difference in % bees exiting the hive` = 100 * (`LPS CHC` - `Ringer CHC`),
           `Log10 odds ratio` = log10(`LPS CHC` / `Ringer CHC`)) %>%
    my_summary(c("Absolute difference in % bees exiting the hive", 
                 "Log10 odds ratio"),
               outcome = "Stayed inside the hive") %>%
    mutate(p = c(" ", format(round(p[2], 4), nsmall = 4))),
  
  plotting_data %>%
    filter(outcome == "Left voluntarily") %>%
    spread(treatment, prop) %>%
    mutate(`Absolute difference in % bees leaving voluntarily` = 100 * (`LPS CHC` - `Ringer CHC`),
           `Log10 odds ratio` = log10(`LPS CHC` / `Ringer CHC`)) %>%
    my_summary(c("Absolute difference in % bees leaving voluntarily", 
                 "Log10 odds ratio"),
               outcome = "Left voluntarily") %>%
    mutate(p = c(" ", format(round(p[2], 4), nsmall = 4))),
  
  plotting_data %>%
    filter(outcome == "Forced out") %>%
    spread(treatment, prop) %>%
    mutate(`Absolute difference in % bees leaving voluntarily` = 100 * (`LPS CHC` - `Ringer CHC`),
           `Log10 odds ratio` = log10(`LPS CHC` / `Ringer CHC`)) %>%
    my_summary(c("Absolute difference in % bees leaving voluntarily", 
                 "Log10 odds ratio"),
               outcome = "Forced out") %>%
    mutate(p = c(" ", format(round(p[2], 4), nsmall = 4))) 
) 

stats_table[c(2,4,6), 1] <- " "

stats_table %>%
  mutate(` ` = ifelse(p < 0.05, "\\*", ""),
         ` ` = replace(` `, p < 0.01, "**"),
         ` ` = replace(` `, p < 0.001, "***"),
         ` ` = replace(` `, p == " ", "")) %>%
  kable(digits = 3) %>% kable_styling() %>% 
  row_spec(c(0,2,4,6), extra_css = "border-bottom: solid;")
```
