---
title: "Analysis of Experiment 3"
editor_options:
  chunk_output_type: console
output: 
  workflowr::wflow_html:
    code_folding: hide 
---

## Load data and R packages

```{r results='hide', message=F, warning=F}
# All but 1 of these packages can be easily installed from CRAN.
# However it was harder to install the showtext package. On Mac, I did this:
# installed 'homebrew' using Terminal: ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" 
# installed 'libpng' using Terminal: brew install libpng
# installed 'showtext' in R using: devtools::install_github("yixuan/showtext")  
library(showtext)

library(brms)
library(bayesplot)
library(tidyverse)
library(gridExtra)
library(kableExtra)
library(bayestestR)
library(cowplot)
library(tidybayes)
library(scales)
source("code/helper_functions.R")

# set up nice font for figure
nice_font <- "PT Serif"
font_add_google(name = nice_font, family = nice_font, regular.wt = 400, bold.wt = 700)
showtext_auto()

files <- c("data/data_collection_sheets/hiveA_touching.csv",
           "data/data_collection_sheets/hiveB_touching.csv",
           "data/data_collection_sheets/hiveC_touching.csv",
           "data/data_collection_sheets/hiveD_touching.csv")

experiment3 <- map(
  files, 
  ~ read_csv(.x) %>%
    gather(minute, touching, -tube) %>%
    mutate(treatment = ifelse(substr(tube, 1, 1) %in% c("A", "B"), "AB", "CD"),
           minute = as.numeric(minute),
           touching = as.integer(touching),
           hive = gsub("hive", "", str_extract(.x, "hive[ABCD]")), 
           tube = paste(hive, tube, sep = "_"))
  ) %>% bind_rows() %>%
  mutate(treatment = replace(treatment, 
                             treatment == "AB" & hive %in% c("A", "B"), 
                             "Ringers"),
         treatment = replace(treatment, 
                             treatment == "AB" & hive %in% c("C", "D"), 
                             "LPS"),
         treatment = replace(treatment, 
                             treatment == "CD" & hive %in% c("A", "B"), 
                             "LPS"),
         treatment = replace(treatment, 
                             treatment == "CD" & hive %in% c("C", "D"), 
                             "Ringers")) %>%
  mutate(hive = replace(hive, hive == "A", "Garden"),
         hive = replace(hive, hive == "B", "Skylab"),
         hive = replace(hive, hive == "C", "Arts"),
         hive = replace(hive, hive == "D", "Zoology"))


expt3_counts <- experiment3 %>%
  group_by(treatment, tube, hive) %>%
  summarise(n_touching = sum(touching),
            n_not_touching = sum(touching== 0),
            percent = n_touching / (n_touching + n_not_touching)) %>% 
  ungroup() %>%
  filter(!is.na(n_touching)) %>%
  mutate(treatment = factor(treatment, c("Ringers", "LPS"))) %>%
  mutate(hive = C(factor(hive), sum)) # sum coding for hive
```

## Inspect the raw data

### Sample sizes by treatment
```{r}
sample_sizes <- expt3_counts %>%
  group_by(treatment) %>%
  summarise(n = n()) 

sample_sizes %>%
  kable() %>% kable_styling(full_width = FALSE)
```

### Sample sizes by treatment and hive
```{r}
expt3_counts %>%
  group_by(hive, treatment) %>%
  summarise(n = n()) %>%
  kable() %>% kable_styling(full_width = FALSE)
```

### Inspect the results 

```{r}
expt3_counts %>%
  group_by(hive, treatment) %>%
  summarise(pc = mean(100 * percent),
            SE = sd(percent) /sqrt(n()),
            n = n()) %>%
  rename(`% observations in which bees were in close contact` = pc,
         Hive = hive, Treatment = treatment) %>% 
  kable(digits = 3) %>% kable_styling(full_width = FALSE) %>%
  column_spec(3, width = "2in")
```

### Plotted as histograms

Note that bees more often spent close to 100% of the observation period in contact in the control group, relative to the group treated with LPS.

```{r}
histo_data <- expt3_counts %>%
  left_join(sample_sizes, by = "treatment") %>%
  arrange(treatment) %>%
  mutate(treatment = factor(paste(treatment, " (n = ", n, ")", sep = ""),
                            unique(paste(treatment, " (n = ", n, ")", sep = "")))) 

raw_histogram <- histo_data %>% 
  filter(grepl("Ringers", treatment)) %>%
  ggplot(aes(100 * percent, 
             fill = treatment)) + 
  geom_histogram(data = histo_data %>% 
                   filter(grepl("LPS", treatment)), 
                 mapping = aes(y = ..density..), 
                 alpha = 0.5, bins = 11, colour = "black", linetype = 2) +
  geom_histogram(mapping = aes(y = ..density..), 
                 alpha = 0.5, bins = 11, 
                 colour = "black") + 
  scale_fill_brewer(palette = "Set1", 
                    direction = 1, name = "Treatment") + 
  xlab("% Time in close contact") + ylab("Density") + 
  theme_bw() + 
  theme(legend.position = c(0.34, 0.832),
        legend.background = element_rect(fill = scales::alpha('white', 0.7)),
        text = element_text(family = nice_font)) 

rm(histo_data)
raw_histogram
```



## Binomial model of time spent in contact

### Run the models

Fit a binomial model, where the response is either a 0 (if bees were not in contact) or 1 (if they were). To assess the effects of our predictor variables, we compare 5 models with different fixed factors, ranking them by posterior model probability.

```{r}
# new verison....
if(!file.exists("output/exp3_model.rds")){
  exp3_model_v1 <- brm(
    n_touching | trials(n) ~ treatment * hive + (1 | tube), 
    data = expt3_counts %>% mutate(n = n_touching + n_not_touching), 
    prior = c(set_prior("normal(0, 3)", class = "b")),
    family = "binomial", save_all_pars = TRUE, sample_prior = TRUE,
    chains = 4, cores = 1, iter = 20000, seed = 1)
  
  exp3_model_v2 <- brm(
    n_touching | trials(n) ~ treatment + hive + (1 | tube), 
    data = expt3_counts %>% mutate(n = n_touching + n_not_touching), 
    prior = c(set_prior("normal(0, 3)", class = "b")),
    family = "binomial", save_all_pars = TRUE, sample_prior = TRUE,
    chains = 4, cores = 1, iter = 20000, seed = 1)
  
  exp3_model_v3 <- brm(
    n_touching | trials(n) ~ hive + (1 | tube), 
    data = expt3_counts %>% mutate(n = n_touching + n_not_touching), 
    prior = c(set_prior("normal(0, 3)", class = "b")),
    family = "binomial",  save_all_pars = TRUE, sample_prior = TRUE,
    chains = 4, cores = 1, iter = 20000, seed = 1)
  
  posterior_model_probabilities <- tibble(
    Model = c("treatment * hive + observation_time_minutes",
              "treatment + hive + observation_time_minutes",
              "hive + observation_time_minutes"),
    post_prob = as.numeric(post_prob(exp3_model_v1,
                                     exp3_model_v2,
                                     exp3_model_v3))) %>%
    arrange(-post_prob)
  
  saveRDS(exp3_model_v2, "output/exp3_model.rds") # save the top model, treatment + hive
  saveRDS(posterior_model_probabilities, "output/exp3_post_prob.rds")
}
exp3_model <- readRDS("output/exp3_model.rds")
model_probabilities <- readRDS("output/exp3_post_prob.rds")
```


### Posterior model probabilites

```{r}
model_probabilities %>% 
  kable(digits = 3) %>% kable_styling(full_width = FALSE)
```

### Fixed effects from the top non-null model

```{r}
tableS5 <- get_fixed_effects_with_p_values(exp3_model) %>% 
  mutate(mu = map_chr(str_extract_all(Parameter, "mu[:digit:]"), ~ .x[1]),
         Parameter = str_remove_all(Parameter, "mu[:digit:]_"),
         Parameter = str_replace_all(Parameter, "treatment", "Treatment: "),
         Parameter = str_replace_all(Parameter, "observation_time_minutes", "Observation duration (minutes)")) %>%
  arrange(mu) %>%
  select(-mu, -Rhat, -Bulk_ESS, -Tail_ESS) 

names(tableS5)[3:5] <- c("Est. Error", "Lower 95% CI", "Upper 95% CI")

saveRDS(tableS5, file = "figures/tableS5.rds")

tableS5 %>%
  kable(digits = 3) %>% 
  kable_styling(full_width = FALSE) 
```
**Table S5:** Table summarising the posterior estimates of each fixed effect in the best-fitting model of Experiment 3 that contained the treatment effect. This was a binomial model where the response variable was 0 for observations in which bees were not in close contact, and 1 when they were. 'Treatment' is a fixed factor with two levels, and the effect of LPS shown here is expressed relative to the 'Ringers' treatment. 'Hive' was a fixed factor with four levels; unlike for treatment, we modelled hive using deviation coding, such that the intercept term represents the mean across all hives (in the Ringers treatment), and the three hive terms represent the deviation from this mean for three of the four hives. The model also included a random effect 'pair ID' (XXXXX), which grouped repeated observations made on each pair of bees, preventing pseudoreplication. The $p$ column gives the posterior probability that the true effect size is opposite in sign to what is reported in the Estimate column, similarly to a p-value.



## Plotting estimates from the model

```{r fig.height=3.2, fig.width=8.6, fig.showtext = TRUE, warning=FALSE}
new <- expt3_counts %>% 
  select(treatment) %>% distinct() %>% 
  mutate(n = 100, key = paste("V", 1:n(), sep = ""),
         hive = NA) 
plotting_data <- as.data.frame(fitted(exp3_model, 
                                      newdata=new, re_formula = NA, summary = FALSE))
names(plotting_data) <- c("LPS", "Ringers")
plotting_data <- plotting_data %>% gather(treatment, percent_time_in_contact)

cols <- c("#34558b", "#4ec5a5", "#ffaf12")

dot_plot <- plotting_data %>%
  mutate(treatment = factor(treatment, c("Ringers", "LPS"))) %>%
  ggplot(aes(percent_time_in_contact, treatment)) + 
  stat_dotsh(quantiles = 100, fill = "grey40", colour = "grey40") + 
  stat_pointintervalh(
    mapping = aes(colour = treatment, fill = treatment),
    .width = c(0.5, 0.95), 
    position = position_nudge(y = -0.07),
    point_colour = "grey26", pch = 21, stroke = 0.4) + 
  xlab("Mean % time in close contact") + ylab("Treatment") + 
  scale_colour_brewer(palette = "Pastel1", 
                      direction = -1, name = "Treatment") +
  scale_fill_brewer(palette = "Pastel1", 
                      direction = -1, name = "Treatment") +
  theme_bw() + 
  coord_cartesian(ylim=c(1.4, 2.4)) + 
  theme(
    text = element_text(family = nice_font),
    strip.background = element_rect(fill = "#eff0f1"),
    panel.grid.major.y = element_blank(),
    legend.position = "none"
  ) 
  
# positive effect = odds of this outcome are higher for trt2 than trt1 (put control as trt1)
get_log_odds <- function(trt1, trt2){ 
  log((trt2 / (1 - trt2) / (trt1 / (1 - trt1))))
}

LOR <- plotting_data %>%
  mutate(posterior_sample = rep(1:(n()/2), 2)) %>%
  spread(treatment, percent_time_in_contact) %>%
  mutate(LOR = get_log_odds(Ringers/100, LPS/100)) %>%
  select(LOR)

LOR_plot <- LOR %>%
  ggplot(aes(LOR, y =1)) + 
  geom_vline(xintercept = 0, linetype = 2) +
  stat_dotsh(quantiles = 100, fill = "grey40", colour = "grey40") + 
  stat_pointintervalh(
    colour = "orange", fill = "orange",
    .width = c(0.5, 0.95), 
    position = position_nudge(y = -0.1),
    point_colour = "grey26", pch = 21, stroke = 0.4) + 
  coord_cartesian(ylim=c(0.86, 2)) + 
  xlab("Effect of LPS on mean\n% time in close contact (LOR)") + 
  ylab("Posterior density") + 
  theme_bw() +
  theme(
    text = element_text(family = nice_font),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "none"
  ) 
 
p <- cowplot::plot_grid(raw_histogram, 
                        dot_plot, LOR_plot,  labels = c("A", "B", "C"),
                        nrow = 1, align = 'h', axis = 'l')
ggsave(plot = p, filename = "figures/fig3.pdf", height = 3.2, width = 8.6)
p
```
**Figure 3:** Panel A shows the frequency distribution of the % time in close contact, for pairs of bees from the LPS treatment and the Ringers control. Panel B shows the posterior estimates of the mean % time spent in close contact; the details of the quantile dot plot and error bars are the same as described for Figure 1. Panel C shows the effect size (LOR; log odds ratio) associated with the difference in means in Panel B.


## Hypothesis testing and effect sizes

```{r}
get_log_odds <- function(trt1, trt2){ 
  log((trt2 / (1 - trt2) / (trt1 / (1 - trt1))))
}

my_summary <- function(df) {
  
  diff <- (df %>% pull(Ringers)) - (df %>% pull(LPS))
  LOR <- get_log_odds((df %>% pull(Ringers))/100, 
                      (df %>% pull(LPS))/100)
  p <- 1 - (diff %>% bayestestR::p_direction() %>% as.numeric())
  diff <- diff %>% posterior_summary() %>% as_tibble()
  LOR <- LOR %>% posterior_summary() %>% as_tibble()
  output <- rbind(diff, LOR) %>% 
    mutate(p=p, 
           Metric = c("Absolute difference in % time in close contact", 
                      "Log odds ratio")) %>% 
      select(Metric, everything()) %>%
    mutate(p = format(round(p, 4), nsmall = 4))
  output$p[1] <- " "
  output
}

plotting_data %>%
  as_tibble() %>%
  mutate(sample = rep(1:(n() / 2), 2)) %>%
  spread(treatment, percent_time_in_contact) %>%
  mutate(difference = LPS - Ringers) %>%
  my_summary() %>%
  mutate(` ` = ifelse(p < 0.05, "\\*", ""),
         ` ` = replace(` `, p < 0.01, "**"),
         ` ` = replace(` `, p < 0.001, "***"),
         ` ` = replace(` `, p == " ", "")) %>%
  kable(digits = 3) %>% kable_styling() 
```
**Table S6:** Pairs in which one bee had received LPS were observed in close contact less frequently than pairs in which one bee had received Ringers solution. 
